container_commands:
  01_collectstatic:
    command: |
      echo "=== CONTAINER COMMAND: Starting collectstatic at $(date) ===" >> /var/log/collectstatic.log
      
      # Activate virtual environment and set up
      source /var/app/venv/*/bin/activate
      cd /var/app/current
      
      # Set environment variables
      export DATABASE_URL=$(/opt/elasticbeanstalk/bin/get-config environment -k DATABASE_URL)
      export SECRET_KEY=$(/opt/elasticbeanstalk/bin/get-config environment -k SECRET_KEY)
      export DEBUG="False"
      export DATABASE_SSL="True"
      
      # Create staticfiles directory
      mkdir -p /var/app/current/staticfiles
      chown webapp:webapp /var/app/current/staticfiles
      chmod 755 /var/app/current/staticfiles
      
      # Run collectstatic
      echo "Running collectstatic..." >> /var/log/collectstatic.log
      python manage.py collectstatic --noinput --clear --verbosity 1 >> /var/log/collectstatic.log 2>&1
      
      # Set permissions
      find /var/app/current/staticfiles -type f -exec chmod 644 {} \;
      find /var/app/current/staticfiles -type d -exec chmod 755 {} \;
      chown -R webapp:webapp /var/app/current/staticfiles
      
      # Verify files exist
      echo "Verifying key files..." >> /var/log/collectstatic.log
      ls -la /var/app/current/staticfiles/admin/js/vendor/select2/ >> /var/log/collectstatic.log 2>&1
      ls -la /var/app/current/staticfiles/autocomplete_light/ >> /var/log/collectstatic.log 2>&1
      
      echo "=== CONTAINER COMMAND: Collectstatic completed at $(date) ===" >> /var/log/collectstatic.log
    leader_only: true